<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hana — WA Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f3f6f4; --card:#fff; --wa-green:#25D366; --wa-dark:#128C7E;
      --muted:#6b7280; --radius:12px; --accent:linear-gradient(135deg,var(--wa-green),#1fa56a);
      --card-shadow: 0 8px 20px rgba(16,24,40,0.06);
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Arial;margin:0;background:linear-gradient(180deg,#eef6f1,var(--bg));color:#0f172a}
    .container{max-width:1100px;margin:28px auto;padding:18px;display:grid;grid-template-columns:320px 1fr;gap:18px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:var(--card-shadow)}
    .header{display:flex;gap:10px;align-items:center}
    .logo{width:44px;height:44px;border-radius:10px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    h1{font-size:18px;margin:0}
    .muted{color:var(--muted);font-size:13px}

    /* left */
    .left-col .status-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .dot{width:10px;height:10px;border-radius:50%;background:#ddd}
    .dot.qr{background:#f59e0b} .dot.auth{background:var(--wa-green)}
    .actions{display:flex;gap:8px}
    .btn{padding:8px 10px;border-radius:8px;border:0;background:transparent;cursor:pointer}
    .qr-area{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:260px;gap:10px}
    .qr-plate{background:#fff;padding:12px;border-radius:10px;box-shadow:0 10px 30px rgba(20,40,20,0.03)}
    .qr-plate img{width:220px;height:220px;display:block}

    /* contacts list as cards */
    .contacts-list{margin-top:12px;max-height:360px;overflow:auto;padding:8px}
    .contact-card{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px;
      border-radius:12px;
      background:linear-gradient(180deg, #ffffff, #f9fff9);
      border:1px solid rgba(200,245,220,0.6);
      margin-bottom:10px;
      box-shadow: 0 6px 18px rgba(18,140,126,0.04),    /* subtle green base */
                  0 1px 0 rgba(255,255,255,0.8) inset;
      cursor:pointer;
      transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease;
      outline: none;
    }

    /* hover: stronger lift + soft green glow */
    .contact-card:hover{
      transform: translateY(-6px);
      box-shadow:
        0 18px 40px rgba(18,140,126,0.12),   /* larger green glow */
        0 6px 18px rgba(12,20,12,0.04);
      border-color: rgba(18,140,126,0.18);
    }

    /* selected: clear green highlight */
    .contact-card.selected{
      border: 2px solid rgba(18,140,126,0.16);
      transform: translateY(-4px) scale(1.01);
      box-shadow:
        0 20px 48px rgba(18,140,126,0.16),
        0 8px 24px rgba(12,20,12,0.06);
    }
    .contact-avatar{
      width:48px;height:48px;border-radius:10px;
      background:linear-gradient(180deg,#eafaf3,#dff6ec);
      color:var(--wa-dark);display:flex;align-items:center;justify-content:center;
      font-weight:700;font-size:16px;
      box-shadow: 0 4px 14px rgba(18,140,126,0.04);
      border: 1px solid rgba(18,140,126,0.06);
    }
    .contact-meta{flex:1;min-width:0}
    .contact-name{font-weight:700;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
    .contact-last{font-size:13px;color:var(--muted);white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
    .contact-right{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
    .contact-unread{
      background: linear-gradient(180deg,var(--wa-green),#1fa56a);
      color:#fff;padding:6px 8px;border-radius:999px;font-size:12px;
      box-shadow: 0 6px 18px rgba(37,211,102,0.12);
    }
    .contact-toggle{transform:scale(1.1)}
    .contact-toggle:focus {
      outline: 2px solid rgba(18,140,126,0.14);
      outline-offset: 2px;
      border-radius: 6px;
    }
    /* right */
    .right-top{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .search{padding:10px;border-radius:10px;border:1px solid #eef2f6;flex:1}
    .log-window{margin-top:12px;min-height:420px;max-height:720px;overflow:auto;padding:12px;border-radius:10px;background:#fff;box-shadow:0 8px 30px rgba(16,24,40,0.04)}
    .msg{display:flex;gap:10px;padding:8px;border-radius:8px;margin-bottom:8px;border:1px solid #f1f5f9}
    .msg-time{min-width:80px;color:var(--muted);font-size:12px}
    .msg-body{flex:1}

    @media (max-width:900px){.container{grid-template-columns:1fr;padding:12px}.qr-plate img{width:180px;height:180px}}
  </style>
</head>
<body>
  <div class="container">
    <div class="left-col">
      <div class="card">
        <div class="header">
          <div class="logo">H</div>
          <div>
            <h1>Hana — WA Dashboard</h1>
          </div>
        </div>

        <div class="status-row" style="margin-top:12px">
          <div style="display:flex;align-items:center;gap:10px">
            <div id="dot" class="dot"></div>
            <div>
              <div id="statusText">Status: connecting...</div>
              <div class="muted" id="subStatus">Menunggu koneksi</div>
            </div>
          </div>
          <div class="actions">
            <button id="clearBtn" class="btn">Clear</button>
            <button id="downloadBtn" class="btn">Download QR</button>
          </div>
        </div>

        <div class="qr-area" style="margin-top:12px">
          <div id="qrBox" style="opacity:0;transition:all .25s">
            <div class="qr-plate"><img id="qr" src="" alt="qr" /></div>
            <div class="muted" style="text-align:center">Scan QR dengan WhatsApp</div>
          </div>
        </div>

        <div style="margin-top:10px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="muted">Kontak</div>
            <div class="muted">Aktif / Nonaktif Bot</div>
          </div>

          <div class="contacts-list" id="contactsList" aria-live="polite" style="margin-top:8px">
            <div class="muted">Belum ada kontak.</div>
          </div>
        </div>
      </div>
    </div>

    <div>
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
        <div style="flex:1">
          <div style="font-weight:700">Logs</div>
          <div class="muted">Klik kontak di kiri untuk lihat riwayat pesan</div>
        </div>
        <input id="search" class="search" placeholder="Cari pesan..." />
      </div>

      <div class="log-window card" id="logWindow">
        <div id="logEmpty" class="muted">Silakan pilih kontak untuk menampilkan riwayat pesan.</div>
        <div id="messages"></div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const statusText = document.getElementById('statusText');
    const subStatus = document.getElementById('subStatus');
    const dot = document.getElementById('dot');
    const qrImg = document.getElementById('qr');
    const qrBox = document.getElementById('qrBox');
    const contactsList = document.getElementById('contactsList');
    const messagesDiv = document.getElementById('messages');
    const logEmpty = document.getElementById('logEmpty');
    const searchInput = document.getElementById('search');
    const downloadBtn = document.getElementById('downloadBtn');
    const clearBtn = document.getElementById('clearBtn');

    let contacts = []; // {id,name,lastMsg,active,unread}
    let messagesCache = {}; // id -> messages
    let selectedContact = null;

    function renderContacts() {
      contactsList.innerHTML = '';
      if (!contacts.length) {
        contactsList.innerHTML = '<div class="muted">Belum ada kontak.</div>';
        return;
      }

      contacts.forEach(c => {
        const card = document.createElement('div');
        card.className = 'contact-card';
        card.setAttribute('role','button');
        card.setAttribute('tabindex','0');
        card.dataset.id = c.id;

        // avatar
        const avatar = document.createElement('div');
        avatar.className = 'contact-avatar';
        avatar.textContent = (c.name||'--').slice(0,2).toUpperCase();

        // meta
        const meta = document.createElement('div');
        meta.className = 'contact-meta';
        const name = document.createElement('div'); name.className='contact-name'; name.textContent = c.name;
        const last = document.createElement('div'); last.className='contact-last'; last.textContent = c.lastMsg || '';
        meta.appendChild(name); meta.appendChild(last);

        // right area: unread + toggle
        const right = document.createElement('div'); right.className='contact-right';
        if (c.unread) {
          const unread = document.createElement('div'); unread.className='contact-unread'; unread.textContent = c.unread;
          right.appendChild(unread);
        }
        const toggle = document.createElement('input'); toggle.type='checkbox'; toggle.checked = !!c.active; toggle.className='contact-toggle';
        toggle.addEventListener('change', (e) => {
          // send toggle request to server
          socket.emit('toggle_contact', { id: c.id, active: e.target.checked });
        });
        right.appendChild(toggle);

        card.appendChild(avatar);
        card.appendChild(meta);
        card.appendChild(right);

        // click + keyboard handlers
        const activate = () => {
          // mark selected style
          document.querySelectorAll('.contact-card').forEach(x=>x.classList.remove('selected'));
          card.classList.add('selected');
          selectedContact = c.id;
          socket.emit('get_messages', c.id);
          if (messagesCache[c.id]) renderMessages(messagesCache[c.id]);
          // focus for keyboard
          card.focus();
        };
        card.addEventListener('click', activate);
        card.addEventListener('keydown', (ev) => { if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); activate(); } });

        contactsList.appendChild(card);
      });
    }

    function renderMessages(msgs) {
      messagesDiv.innerHTML = '';
      if (!msgs || !msgs.length) { logEmpty.style.display = 'block'; return; }
      logEmpty.style.display = 'none';
      msgs.slice().reverse().forEach(m => {
        const wrap = document.createElement('div'); wrap.className='msg';
        const t = document.createElement('div'); t.className='msg-time';
        // m.ts might be in seconds or ms
        const ts = String(m.ts).length === 13 ? m.ts : (String(m.ts).length === 10 ? m.ts*1000 : m.ts);
        t.textContent = new Date(ts).toLocaleString();
        const b = document.createElement('div'); b.className='msg-body';
        const from = document.createElement('div'); from.style.fontWeight='700'; from.style.color='#128C7E';
        from.textContent = (m.from||'').replace('@c.us','');
        const body = document.createElement('div'); body.textContent = m.body || '';
        b.appendChild(from); b.appendChild(body);
        wrap.appendChild(t); wrap.appendChild(b);
        messagesDiv.appendChild(wrap);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // socket listeners
    socket.on('connect', () => {
      statusText.textContent = 'Status: connected';
      subStatus.textContent = 'Menunggu data dari server...';
      dot.className = 'dot';
    });

    socket.on('status', s => {
      if (s === 'qr') { statusText.textContent='Status: QR'; dot.className='dot qr'; qrBox.style.opacity=1; subStatus.textContent='Scan QR dengan WhatsApp'; }
      else if (s === 'authenticated') { statusText.textContent='Status: Authenticated'; dot.className='dot auth'; qrBox.style.opacity=0; subStatus.textContent='Session tersimpan'; }
      else if (s === 'ready') { statusText.textContent='Status: Ready'; dot.className='dot auth'; qrBox.style.opacity=0; subStatus.textContent='WhatsApp siap'; }
      else { statusText.textContent = 'Status: ' + s; subStatus.textContent=''; }
    });

    socket.on('qr', dataUrl => {
      qrImg.src = dataUrl; qrImg.dataset.latest = dataUrl;
      qrImg.onload = () => qrBox.style.opacity = 1;
    });

    socket.on('contacts', arr => {
      // server sends contacts array (sorted)
      contacts = arr;
      renderContacts();
    });

    socket.on('message', m => {
      const id = m.from;
      messagesCache[id] = messagesCache[id] || [];
      messagesCache[id].push({ from: m.from, body: m.body, ts: m.ts || Math.floor(Date.now()/1000) });
      // auto refresh current view
      if (selectedContact === id) renderMessages(messagesCache[id]);
    });

    socket.on('messages_for', payload => {
      messagesCache[payload.id] = payload.messages || [];
      if (selectedContact === payload.id) renderMessages(messagesCache[payload.id]);
    });

    socket.on('toggled', ({ id, active }) => {
      // server will re-emit contacts; UI will update in contacts event
    });

    // search filter (client-side on selected contact)
    searchInput.addEventListener('input', e => {
      const q = e.target.value.toLowerCase();
      if (!selectedContact) return;
      const filtered = (messagesCache[selectedContact] || []).filter(m => (m.body||'').toLowerCase().includes(q));
      renderMessages(filtered);
    });

    clearBtn.addEventListener('click', () => { messagesDiv.innerHTML=''; logEmpty.style.display='block'; });

    downloadBtn.addEventListener('click', () => {
      const data = qrImg.dataset.latest || qrImg.src;
      if (!data) return alert('QR belum tersedia');
      const a = document.createElement('a'); a.href = data; a.download = 'whatsapp-qr.png'; a.click();
    });
  </script>
</body>
</html>
